name: Build Base (CI:Base → ECR)

on:
  # Manual run (optional)
  workflow_dispatch: {}
  # Only react to PR merges; job itself will gate on the label
  pull_request:
    types: [closed]
    branches: [ master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  build-base:
    # Gate: must be a merged PR AND must include CI:Base label
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'CI:Base')

    runs-on: ubuntu-latest

    # Make AWS creds & constants available to ALL steps
    env:
      # IAM user credentials (set these as repo Secrets)
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Region / account (use Variables or hardcode)
      AWS_REGION:            ${{ vars.AWS_REGION }}
      AWS_DEFAULT_REGION:    ${{ vars.AWS_REGION }}

      # ECR registry + repo for BASE image
      ECR_REGISTRY:          ${{ vars.ECR_REGISTRY }}
      ECR_BASE_REPO:         ${{ vars.ECR_BASE_REPO }}
      IMAGE_URI:             ${{ vars.IMAGE_URI }}

    steps:
      - uses: actions/checkout@v4
        with:
          # Build the merged code (base ref of the PR)
          ref: ${{ github.event.pull_request.base.ref || 'master' }}

      # (Optional) Sanity: confirm creds are usable
      - name: Who am I
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - name: Compute tag
        id: tag
        run: |
          SHA="${{ github.sha }}"
          echo "short=${SHA::6}" >> "$GITHUB_OUTPUT"
      
      - name: Build & push base image
        run: |
          TAG="base-${{ steps.tag.outputs.short }}"
          echo "Building image with tag: $TAG"
      
          docker build -f docker/base/Dockerfile -t "$IMAGE_URI:$TAG" .
          docker push "$IMAGE_URI:$TAG"
      
          echo "✅ Image pushed: $IMAGE_URI:$TAG"
      


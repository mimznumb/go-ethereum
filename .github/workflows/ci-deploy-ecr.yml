name: Deploy (CI:Deploy â†’ predeployed ECR image)

on:
  pull_request:
    types: [closed]
    branches: [ master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  test:
    if: >
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'CI:Deploy')

    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION:            ${{ vars.AWS_REGION }}
      AWS_DEFAULT_REGION:    ${{ vars.AWS_REGION }}
      ECR_DEVNET_REGISTRY:   ${{ vars.ECR_DEVNET_REGISTRY }}
      IMAGE_DEVNET_URI:      ${{ vars.IMAGE_DEVNET_URI }}
      DEV_ACCOUNT:           ${{ secrets.DEV_ACCOUNT }}

    steps:
      - name: Checkout merged code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref || 'master' }}

      - name: Compute short tag
        id: tag
        run: |
          SHORT=$(echo "${{ github.event.pull_request.merge_commit_sha }}" | cut -c1-6)
          echo "short=$SHORT" >> "$GITHUB_OUTPUT"

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_DEVNET_REGISTRY"

      - name: Pull latest devnet image
        id: pick
        run: |
          echo "Fetching latest tag for $IMAGE_DEVNET_URI..."
          LATEST_TAG=$(aws ecr describe-images \
            --repository-name geth-devnet \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)
          echo "Latest tag: $LATEST_TAG"
          docker pull "$IMAGE_DEVNET_URI:$LATEST_TAG"
          echo "src=$IMAGE_DEVNET_URI:$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Start devnet
        run: |
          docker run -d --name devnet \
            -p 8545:8545 \
            "${{ steps.pick.outputs.src }}" \
            geth --dev \
                 --http --http.addr 0.0.0.0 \
                 --http.api eth,net,web3,txpool,debug \
                 --allow-insecure-unlock \
                 --unlock "$DEV_ACCOUNT" \
                 --password /dev/null

      - name: Wait for RPC
        run: |
          for i in {1..30}; do
            if curl -sf -H 'content-type: application/json' \
              --data '{"jsonrpc":"2.0","id":1,"method":"web3_clientVersion","params":[]}' \
              http://127.0.0.1:8545 >/dev/null; then
              echo "RPC up"
              exit 0
            fi
            sleep 1
          done
          echo "RPC not ready"
          docker logs devnet || true
          exit 1

      - name: Fund Hardhat test account
        run: |
          # Get the first dev account (unlocked)
          DEV_ACCT=$(curl -s -H 'content-type: application/json' \
            --data '{"jsonrpc":"2.0","id":1,"method":"eth_accounts","params":[]}' \
            http://127.0.0.1:8545 | jq -r '.result[0]')
          echo "Dev account: $DEV_ACCT"

          # The Hardhat default deployer address (same as in scripts/deploy.ts)
          TARGET=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266

          # Send 100 ETH to the Hardhat account
          TX=$(curl -s -H 'content-type: application/json' \
            --data "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"eth_sendTransaction\",\"params\":[{\"from\":\"$DEV_ACCT\",\"to\":\"$TARGET\",\"value\":\"0x56BC75E2D63100000\"}]}" \
            http://127.0.0.1:8545 | jq -r '.result')

          echo "Funding tx: $TX"

          sleep 2
          BAL=$(curl -s -H 'content-type: application/json' \
            --data "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"eth_getBalance\",\"params\":[\"$TARGET\",\"latest\"]}" \
            http://127.0.0.1:8545 | jq -r '.result')
          echo "Hardhat test account balance: $BAL"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Hardhat deps
        working-directory: hardhat
        run: npm ci

      - name: Run Counter tests
        working-directory: hardhat
        env:
          RPC_URL: http://127.0.0.1:8545
        run: |
          npx hardhat clean || true
          npx hardhat compile
          npx hardhat test test/Counter.ts --network localdevnet

      - name: Stop devnet
        if: always()
        run: docker rm -f devnet || true

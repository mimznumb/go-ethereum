name: Deploy (CI:Deploy → build, test, push to DEST repo)

on:
  pull_request:
    types: [closed]
    branches: [ master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  deploy:
    if: >
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'CI:Deploy')

    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION:            ${{ vars.AWS_REGION }}
      AWS_DEFAULT_REGION:    ${{ vars.AWS_REGION }}

      # ECR registry hostname (same account/region as your repos)
      ECR_DEPLOY_REGISTRY:   ${{ vars.ECR_DEPLOY_REGISTRY }}

      # DESTINATION repo (DIFFERENT repo to push validated image)
      IMAGE_DEPLOY_URI: ${{ vars.IMAGE_DEPLOY_URI }}

      # Hardhat/Geth
      DEV_ACCOUNT:           ${{ secrets.DEV_ACCOUNT }}
      RPC_URL:               http://127.0.0.1:8545

    steps:
      - name: Checkout merged code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref || 'master' }}

      - name: Compute 6-char tag
        id: tag
        run: |
          SHORT=$(echo "${{ github.event.pull_request.merge_commit_sha }}" | cut -c1-6)
          echo "short=$SHORT" >> "$GITHUB_OUTPUT"
          echo "local_tag=local/devnet:${SHORT}" >> "$GITHUB_OUTPUT"

      # If your Dockerfile pulls a base image from ECR (e.g., geth-base), we must login before build.
      - name: Login to ECR (for possible FROM pulls)
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_DEPLOY_REGISTRY"

      # ---------- BUILD (LOCAL TAG ONLY) ----------
      - name: Build devnet image (local tag)
        run: |
          docker build \
            -f docker/devnet/Dockerfile \
            -t "${{ steps.tag.outputs.local_tag }}" \
            .

      # ---------- START & TEST ----------
      - name: Start devnet container
        run: |
          docker run -d --name devnet \
            -p 8545:8545 \
            "${{ steps.tag.outputs.local_tag }}" \
            geth --dev \
                 --http --http.addr 0.0.0.0 \
                 --http.api eth,net,web3,txpool,debug \
                 --allow-insecure-unlock \
                 --unlock "$DEV_ACCOUNT" \
                 --password /dev/null

      - name: Wait for RPC
        run: |
          for i in {1..60}; do
            if curl -sf -H 'content-type: application/json' \
                 --data '{"jsonrpc":"2.0","id":1,"method":"web3_clientVersion","params":[]}' \
                 "$RPC_URL" >/dev/null; then
              echo "RPC up"; exit 0
            fi
            sleep 1
          done
          echo "RPC not responding"
          docker logs devnet || true
          exit 1

      - name: Fund Hardhat default signer
        run: |
          DEV_ACCT=$(curl -s -H 'content-type: application/json' \
            --data '{"jsonrpc":"2.0","id":1,"method":"eth_accounts","params":[]}' \
            "$RPC_URL" | jq -r '.result[0]')
          echo "Dev account: $DEV_ACCT"
          TARGET=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
          TX=$(curl -s -H 'content-type: application/json' \
            --data "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"eth_sendTransaction\",\"params\":[{\"from\":\"$DEV_ACCT\",\"to\":\"$TARGET\",\"value\":\"0x56BC75E2D63100000\"}]}" \
            "$RPC_URL" | jq -r '.result')
          echo "Funding tx: $TX"

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Hardhat deps
        working-directory: hardhat
        run: npm ci

      - name: Run Counter tests (Hardhat)
        working-directory: hardhat
        env:
          RPC_URL: ${{ env.RPC_URL }}
        run: |
          npx hardhat clean || true
          npx hardhat compile
          npx hardhat test test/Counter.ts --network localdevnet

      - name: Stop devnet
        if: always()
        run: docker rm -f devnet || true

      # ---------- RETAG & PUSH TO DEST REPO (ONLY IF TESTS PASSED) ----------
      - name: Push validated image to DEST ECR repo
        if: success()
        run: |
          TAG="pre-${{ steps.tag.outputs.short }}"
          SRC="${{ steps.tag.outputs.local_tag }}"
          DST="${IMAGE_DEPLOY_URI}:${TAG}"

          echo "Retagging $SRC -> $DST"
          docker tag "$SRC" "$DST"

          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_DEPLOY_REGISTRY"

          docker push "$DST"
          echo "✅ Pushed $DST"

name: Build (CI:Build â†’ ECR)

on:
  # Only runs when a PR to master is merged
  pull_request:
    types: [closed]
    branches: [ master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    # Gate: only run when PR is merged and labeled CI:Build
    if: >
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'CI:Build')

    runs-on: ubuntu-latest

    env:
      # ðŸ” AWS IAM user credentials (stored as repo secrets)
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # ðŸŒ AWS region
      AWS_REGION:            ${{ vars.AWS_REGION }}
      AWS_DEFAULT_REGION:    ${{ vars.AWS_REGION }}

      # ðŸ³ ECR repo details
      ECR_DEVNET_REGISTRY:          ${{ vars.ECR_DEVNET_REGISTRY }}
      ECR_DEVNET_REPO:              ${{ vars.ECR_DEVNET_REPO }}
      IMAGE_DEVNET_URI:             ${{ vars.IMAGE_DEVNET_URI }} 

    steps:
      - name: Check out merged code (target branch head)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref || 'master' }}

      - name: Who am I (sanity check)
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_DEVNET_REGISTRY"

      - name: Compute 6-char commit SHA tag
        id: tag
        run: |
          SHA="${{ github.event.pull_request.merge_commit_sha }}"
          SHORTSHA="${SHA::6}"
          echo "short=$SHORTSHA" >> "$GITHUB_OUTPUT"

      - name: Build & push devnet image
        run: |
          TAG="devnet-${{ steps.tag.outputs.short }}"
          echo "Building image with tag: $TAG"

          docker build -f docker/devnet/Dockerfile -t "$IMAGE_DEVNET_URI:$TAG" .
          docker push "$IMAGE_DEVNET_URI:$TAG"

          echo "Image pushed: $IMAGE_DEVNET_URI:$TAG"
